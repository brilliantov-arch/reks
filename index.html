<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#1a8fd1">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="WalkieTalkie">
<title>WalkieTalkie</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.5.2/peerjs.min.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Orbitron:wght@400;700;900&display=swap');

:root{
  --blue:#1a8fd1;--green:#39ff14;--green-dark:#1db800;
  --lcd-bg:#0f2200;--yellow:#ffd60a;--red:#ff3b30;
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
html,body{height:100%;overflow:hidden;}
body{
  background:var(--blue);font-family:'Share Tech Mono',monospace;
  display:flex;justify-content:center;align-items:flex-start;
}
body::before{
  content:'';position:fixed;inset:0;
  background-image:radial-gradient(circle,rgba(255,255,255,0.055) 1px,transparent 1px);
  background-size:18px 18px;pointer-events:none;z-index:0;
}

/* â”€â”€ DEVICE â”€â”€ */
.device{
  width:100%;max-width:390px;height:100vh;
  background:linear-gradient(165deg,#2199d8 0%,#1478b8 45%,#0d6096 100%);
  display:flex;flex-direction:column;align-items:center;
  padding:env(safe-area-inset-top,16px) 18px env(safe-area-inset-bottom,24px);
  position:relative;z-index:1;overflow-y:auto;
  box-shadow:inset 2px 0 30px rgba(0,0,0,0.15),inset -2px 0 30px rgba(0,0,0,0.15);
}
.device-status{
  width:100%;display:flex;justify-content:space-between;align-items:center;
  margin-bottom:12px;padding-top:4px;flex-shrink:0;
}
.device-time{font-size:13px;color:rgba(255,255,255,0.85);letter-spacing:1px;}

/* power */
.power-btn{
  width:40px;height:40px;border-radius:50%;
  background:radial-gradient(circle at 38% 32%,#484848,#111);
  border:2px solid #444;display:flex;align-items:center;justify-content:center;
  cursor:pointer;box-shadow:0 3px 8px rgba(0,0,0,0.55),inset 0 1px 1px rgba(255,255,255,0.07);
  transition:transform .1s;flex-shrink:0;
}
.power-btn:active{transform:scale(.91);}
.power-icon{
  width:18px;height:18px;border:2.5px solid var(--green);border-radius:50%;
  border-top-color:transparent;position:relative;box-shadow:0 0 8px var(--green);
}
.power-icon::after{
  content:'';position:absolute;top:-5px;left:50%;transform:translateX(-50%);
  width:2.5px;height:8px;background:var(--green);box-shadow:0 0 6px var(--green);
}

/* â”€â”€ LCD â”€â”€ */
.lcd-panel{
  width:100%;background:#0a0a0a;border-radius:14px;padding:10px;
  box-shadow:0 5px 18px rgba(0,0,0,0.65),inset 0 2px 5px rgba(0,0,0,0.9);
  border:2px solid #0d0d0d;margin-bottom:6px;flex-shrink:0;
}
.lcd-screen{
  background:var(--lcd-bg);border-radius:8px;padding:10px 14px;
  position:relative;overflow:hidden;
  box-shadow:inset 0 2px 10px rgba(0,0,0,0.7),0 0 24px rgba(57,255,20,0.1);
  min-height:68px;display:flex;align-items:center;justify-content:space-between;
  cursor:pointer;
}
.lcd-screen::after{
  content:'';position:absolute;inset:0;border-radius:8px;
  background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,0,0,0.1) 2px,rgba(0,0,0,0.1) 4px);
  pointer-events:none;
}
.lcd-freq{
  font-family:'Orbitron',monospace;font-size:44px;font-weight:900;
  color:var(--green);letter-spacing:5px;
  text-shadow:0 0 12px var(--green),0 0 35px rgba(57,255,20,0.35);
  line-height:1;user-select:none;
}
.lcd-info{display:flex;flex-direction:column;align-items:flex-end;gap:5px;}
.lcd-count{
  font-family:'Orbitron',monospace;font-size:22px;font-weight:700;
  color:var(--green);text-shadow:0 0 8px var(--green);
}
.lcd-status{font-size:10px;color:var(--green-dark);letter-spacing:2px;text-transform:uppercase;}
.lcd-status.on{color:var(--green);text-shadow:0 0 6px var(--green);animation:blink 1.4s ease-in-out infinite;}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.35}}

/* â”€â”€ CONTROLS â”€â”€ */
.controls-row{
  display:grid;grid-template-columns:repeat(4,1fr);gap:6px;
  width:100%;padding:8px 0 2px;
}
.ctrl-btn{
  background:linear-gradient(150deg,#3c3c3e,#252527);
  border:none;border-radius:9px;color:#fff;
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  gap:3px;padding:10px 4px 8px;cursor:pointer;
  box-shadow:0 4px 7px rgba(0,0,0,0.45),inset 0 1px 0 rgba(255,255,255,0.07);
  transition:all .1s;user-select:none;
}
.ctrl-btn:active{transform:scale(.92) translateY(1px);box-shadow:0 1px 3px rgba(0,0,0,0.4);}
.ctrl-btn svg{width:20px;height:20px;}
.ctrl-btn span{font-size:10px;color:#999;letter-spacing:.5px;}

.divider{
  width:100%;height:1px;flex-shrink:0;
  background:linear-gradient(90deg,transparent,rgba(255,255,255,0.14),transparent);
  margin:14px 0 10px;
}

/* â”€â”€ PEERS â”€â”€ */
.section-label{font-size:10px;color:rgba(255,255,255,.45);letter-spacing:2px;margin-bottom:7px;}
.peer-list{width:100%;display:flex;flex-direction:column;gap:5px;min-height:36px;}
.peer-item{
  display:flex;align-items:center;gap:10px;padding:7px 12px;
  background:rgba(0,0,0,.22);border-radius:9px;
  font-size:12px;color:rgba(255,255,255,.8);letter-spacing:1px;
  transition:background .2s;
}
.peer-dot{
  width:8px;height:8px;border-radius:50%;flex-shrink:0;
  background:var(--green);box-shadow:0 0 6px var(--green);transition:all .2s;
}
.peer-item.speaking{background:rgba(255,213,10,.14);}
.peer-item.speaking .peer-dot{background:var(--yellow);box-shadow:0 0 8px var(--yellow);animation:spk .35s step-end infinite;}
@keyframes spk{50%{opacity:.15}}
.empty-peers{font-size:11px;color:rgba(255,255,255,.28);letter-spacing:1px;text-align:center;padding:8px 0;}

/* â”€â”€ SPEAKER â”€â”€ */
.speaker-area{
  width:100%;flex:1;display:flex;flex-direction:column;
  align-items:center;justify-content:center;gap:20px;padding:8px 0 4px;
}
.speaker-wrapper{position:relative;width:100%;display:flex;justify-content:center;}
.speaker-grille{display:grid;gap:10px;}
.grille-row{display:flex;justify-content:center;gap:12px;}
.grille-dot{
  width:7px;height:7px;border-radius:50%;
  background:rgba(0,0,0,.38);box-shadow:inset 0 1px 2px rgba(0,0,0,.55);
  transition:background .07s;
}
.grille-dot.lit{background:rgba(57,255,20,.55);box-shadow:0 0 5px var(--green);}
.ptt-label-overlay{
  position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
  font-family:'Orbitron',monospace;font-size:11px;font-weight:700;
  color:rgba(255,255,255,.65);letter-spacing:3px;pointer-events:none;white-space:nowrap;
  text-shadow:0 1px 4px rgba(0,0,0,.6);
}

/* â”€â”€ PTT â”€â”€ */
.ptt-btn{
  width:175px;height:64px;border-radius:32px;
  background:linear-gradient(155deg,#1e6eb4,#0c4e84);
  border:3px solid rgba(255,255,255,.16);color:#fff;
  font-family:'Orbitron',monospace;font-size:13px;font-weight:700;letter-spacing:2px;
  cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;
  box-shadow:0 7px 22px rgba(0,0,0,.45),inset 0 2px 4px rgba(255,255,255,.1);
  transition:all .12s;user-select:none;-webkit-user-select:none;touch-action:none;
  position:relative;overflow:hidden;flex-shrink:0;
}
.ptt-btn::before{
  content:'';position:absolute;inset:0;border-radius:30px;
  background:linear-gradient(180deg,rgba(255,255,255,.09) 0%,transparent 60%);
}
.ptt-btn.tx{
  background:linear-gradient(155deg,#22a350,#14622e);border-color:var(--green);
  box-shadow:0 4px 12px rgba(0,0,0,.4),0 0 28px rgba(57,255,20,.45);
  transform:scale(.97) translateY(2px);
}
.ptt-btn.rx{
  background:linear-gradient(155deg,#b55800,#8a3c00);border-color:#ff9400;
  animation:rxp .65s ease-in-out infinite;
}
.ptt-btn.sending{
  background:linear-gradient(155deg,#2354aa,#183c7e);border-color:#5599ff;
  box-shadow:0 4px 12px rgba(0,0,0,.4),0 0 28px rgba(85,153,255,.4);
}
@keyframes rxp{
  0%,100%{box-shadow:0 4px 12px rgba(0,0,0,.4),0 0 18px rgba(255,148,0,.3)}
  50%{box-shadow:0 4px 12px rgba(0,0,0,.4),0 0 42px rgba(255,148,0,.65)}
}
.ptt-icon{width:22px;height:22px;flex-shrink:0;}

/* progress */
.send-progress{
  height:3px;width:100%;background:rgba(255,255,255,.08);
  border-radius:2px;overflow:hidden;display:none;margin-bottom:4px;flex-shrink:0;
}
.send-progress.vis{display:block;}
.send-bar{height:100%;background:linear-gradient(90deg,var(--green),#55aaff);border-radius:2px;width:0%;transition:width .08s;}

/* â”€â”€ TOAST â”€â”€ */
.toast{
  position:fixed;top:22px;left:50%;
  transform:translateX(-50%) translateY(-90px);
  background:rgba(5,5,5,.9);color:#fff;padding:10px 22px;border-radius:22px;
  font-size:13px;letter-spacing:1px;
  transition:transform .3s cubic-bezier(.34,1.56,.64,1);
  z-index:500;white-space:nowrap;
  border:1px solid rgba(255,255,255,.09);backdrop-filter:blur(12px);
}
.toast.show{transform:translateX(-50%) translateY(0);}

/* â”€â”€ NUMPAD â”€â”€ */
.overlay{
  position:fixed;inset:0;background:rgba(0,0,0,.75);
  display:flex;align-items:flex-end;justify-content:center;
  z-index:300;opacity:0;pointer-events:none;
  transition:opacity .2s;backdrop-filter:blur(5px);
}
.overlay.open{opacity:1;pointer-events:all;}
.numpad{
  background:linear-gradient(180deg,#1c1c1f,#101012);
  border-radius:22px 22px 0 0;padding:22px 16px 44px;
  width:100%;max-width:390px;
  box-shadow:0 -12px 44px rgba(0,0,0,.55);
}
.np-title{text-align:center;color:rgba(255,255,255,.45);font-size:11px;letter-spacing:3px;margin-bottom:14px;}
.np-display{
  font-family:'Orbitron',monospace;font-size:44px;font-weight:900;
  color:var(--green);text-align:center;letter-spacing:9px;
  text-shadow:0 0 12px var(--green);margin-bottom:20px;
  min-height:60px;display:flex;align-items:center;justify-content:center;
}
.np-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:9px;}
.np-btn{
  background:linear-gradient(155deg,#2e2e30,#1c1c1e);border:none;border-radius:13px;
  color:#fff;font-family:'Orbitron',monospace;font-size:24px;font-weight:700;
  height:66px;cursor:pointer;
  box-shadow:0 4px 9px rgba(0,0,0,.45),inset 0 1px 0 rgba(255,255,255,.055);
  transition:all .1s;display:flex;align-items:center;justify-content:center;user-select:none;
}
.np-btn:active{transform:scale(.92);}
.np-btn.del{font-size:18px;color:var(--red);}
.np-btn.ok{
  background:linear-gradient(155deg,#1c7a3c,#0c5224);color:var(--green);font-size:13px;
  box-shadow:0 4px 9px rgba(0,0,0,.45),0 0 12px rgba(57,255,20,.18);
}
.np-btn.ok:active{background:linear-gradient(155deg,#27b555,#196833);}

/* â”€â”€ MODAL (token share / join) â”€â”€ */
.modal{
  position:fixed;inset:0;background:rgba(0,0,0,.78);
  display:flex;align-items:center;justify-content:center;
  z-index:400;opacity:0;pointer-events:none;
  transition:opacity .22s;backdrop-filter:blur(6px);padding:20px;
}
.modal.open{opacity:1;pointer-events:all;}
.modal-box{
  background:linear-gradient(170deg,#1c1c1f,#101012);
  border-radius:20px;padding:26px 22px 28px;
  width:100%;max-width:340px;
  box-shadow:0 20px 60px rgba(0,0,0,.7);
  border:1px solid rgba(255,255,255,.07);
}
.modal-title{
  font-family:'Orbitron',monospace;font-size:13px;font-weight:700;
  color:var(--green);text-shadow:0 0 8px var(--green);
  letter-spacing:3px;margin-bottom:16px;text-align:center;
}
.modal-desc{font-size:12px;color:rgba(255,255,255,.5);letter-spacing:1px;line-height:1.6;margin-bottom:18px;text-align:center;}
.token-box{
  background:#0a0a0a;border-radius:12px;padding:14px 16px;
  font-family:'Orbitron',monospace;font-size:22px;font-weight:700;
  color:var(--green);letter-spacing:6px;text-align:center;
  text-shadow:0 0 10px var(--green);
  border:1px solid rgba(57,255,20,.2);
  margin-bottom:18px;cursor:pointer;
  box-shadow:inset 0 2px 8px rgba(0,0,0,.6),0 0 14px rgba(57,255,20,.08);
}
.token-hint{font-size:10px;color:rgba(255,255,255,.3);letter-spacing:1px;text-align:center;margin-bottom:18px;}
.modal-btns{display:flex;gap:10px;}
.modal-btn{
  flex:1;height:52px;border:none;border-radius:13px;cursor:pointer;
  font-family:'Orbitron',monospace;font-size:12px;font-weight:700;letter-spacing:1px;
  transition:all .12s;user-select:none;
}
.modal-btn.primary{
  background:linear-gradient(155deg,#1c7a3c,#0c5224);color:var(--green);
  box-shadow:0 4px 12px rgba(0,0,0,.4),0 0 16px rgba(57,255,20,.2);
}
.modal-btn.primary:active{transform:scale(.96);}
.modal-btn.secondary{
  background:linear-gradient(155deg,#2e2e30,#1c1c1e);color:rgba(255,255,255,.6);
  box-shadow:0 4px 12px rgba(0,0,0,.4);
}
.modal-btn.secondary:active{transform:scale(.96);}

/* token input */
.token-input{
  width:100%;background:#0a0a0a;border:1px solid rgba(57,255,20,.25);
  border-radius:12px;padding:14px 16px;
  font-family:'Orbitron',monospace;font-size:22px;font-weight:700;
  color:var(--green);letter-spacing:6px;text-align:center;
  outline:none;margin-bottom:6px;
  text-shadow:0 0 8px var(--green);
  box-shadow:inset 0 2px 8px rgba(0,0,0,.6);
  -webkit-appearance:none;
}
.token-input::placeholder{color:rgba(57,255,20,.2);letter-spacing:4px;}
.token-input:focus{border-color:rgba(57,255,20,.5);box-shadow:inset 0 2px 8px rgba(0,0,0,.6),0 0 14px rgba(57,255,20,.15);}
</style>
</head>
<body>

<div class="device">
  <div class="device-status">
    <div class="device-time" id="clock">00:00</div>
    <div class="power-btn" id="powerBtn"><div class="power-icon"></div></div>
  </div>

  <!-- LCD -->
  <div class="lcd-panel">
    <div class="lcd-screen" id="lcdScreen" onclick="openNumpad()">
      <div class="lcd-freq" id="freqDisplay">----</div>
      <div class="lcd-info">
        <div class="lcd-count" id="peerCount">0</div>
        <div class="lcd-status" id="statusLabel">OFFLINE</div>
      </div>
    </div>
    <div class="controls-row">
      <button class="ctrl-btn" onclick="openNumpad()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="11" width="18" height="11" rx="2"/>
          <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
        </svg>
        <span>Mode</span>
      </button>
      <button class="ctrl-btn" onclick="changeFreq(-1)">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
          <polyline points="6 9 12 15 18 9"/>
        </svg>
        <span>Down</span>
      </button>
      <button class="ctrl-btn" onclick="changeFreq(1)">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
          <polyline points="6 15 12 9 18 15"/>
        </svg>
        <span>Up</span>
      </button>
      <button class="ctrl-btn" id="inviteBtn" onclick="openInviteModal()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="5" y1="12" x2="19" y2="12"/>
          <polyline points="12 5 19 12 12 19"/>
        </svg>
        <span>Invite</span>
      </button>
    </div>
  </div>

  <div class="divider"></div>

  <div style="width:100%">
    <div class="section-label">USERS ON CHANNEL</div>
    <div class="peer-list" id="peerList">
      <div class="empty-peers">â€” set frequency to start â€”</div>
    </div>
  </div>

  <div class="divider"></div>

  <div class="send-progress" id="sendProg"><div class="send-bar" id="sendBar"></div></div>

  <div class="speaker-area">
    <div class="speaker-wrapper">
      <div class="speaker-grille" id="grille"></div>
      <div class="ptt-label-overlay">PUSH TO TALK</div>
    </div>
    <button class="ptt-btn" id="pttBtn"
      onmousedown="pttDown()" onmouseup="pttUp()" onmouseleave="pttUp()"
      ontouchstart="pttDown(event)" ontouchend="pttUp(event)" ontouchcancel="pttUp(event)">
      <svg class="ptt-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/>
        <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
        <line x1="12" y1="19" x2="12" y2="23"/>
        <line x1="8" y1="23" x2="16" y2="23"/>
      </svg>
      <span id="pttLabel">TALK</span>
    </button>
  </div>
</div>

<!-- Numpad -->
<div class="overlay" id="numpadOv" onclick="closeOvOut(event,'numpadOv')">
  <div class="numpad">
    <div class="np-title">ENTER FREQUENCY</div>
    <div class="np-display" id="npDisplay">____</div>
    <div class="np-grid">
      <button class="np-btn" onclick="np(1)">1</button>
      <button class="np-btn" onclick="np(2)">2</button>
      <button class="np-btn" onclick="np(3)">3</button>
      <button class="np-btn" onclick="np(4)">4</button>
      <button class="np-btn" onclick="np(5)">5</button>
      <button class="np-btn" onclick="np(6)">6</button>
      <button class="np-btn" onclick="np(7)">7</button>
      <button class="np-btn" onclick="np(8)">8</button>
      <button class="np-btn" onclick="np(9)">9</button>
      <button class="np-btn del" onclick="npDel()">&#9003;</button>
      <button class="np-btn" onclick="np(0)">0</button>
      <button class="np-btn ok" onclick="npOk()">TUNE</button>
    </div>
  </div>
</div>

<!-- Invite modal (host) -->
<div class="overlay" id="inviteOv">
  <div class="modal-box">
    <div class="modal-title">INVITE TO FREQ <span id="inviteFreqLabel">----</span></div>
    <div class="modal-desc">Share this code with up to 3 friends.<br>They tap Invite â†’ Join and enter it.</div>
    <div class="token-box" id="tokenDisplay" onclick="copyToken()">----</div>
    <div class="token-hint">Tap code to copy link</div>
    <div class="modal-btns">
      <button class="modal-btn primary" onclick="copyToken()">Copy link</button>
      <button class="modal-btn secondary" onclick="closeOv('inviteOv')">Close</button>
    </div>
  </div>
</div>

<!-- Join modal (guest) -->
<div class="overlay" id="joinOv">
  <div class="modal-box">
    <div class="modal-title">JOIN CHANNEL</div>
    <div class="modal-desc">Enter the 8-digit code from your contact</div>
    <input class="token-input" id="joinInput" maxlength="8" placeholder="00000000"
      oninput="joinInputHandler(this)" inputmode="numeric"/>
    <div class="token-hint" id="joinHint">Enter code to connect</div>
    <div class="modal-btns" style="margin-top:14px;">
      <button class="modal-btn primary" onclick="joinByToken()">Connect</button>
      <button class="modal-btn secondary" onclick="closeOv('joinOv')">Cancel</button>
    </div>
  </div>
</div>

<div class="toast" id="toastEl"></div>

<script>
'use strict';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CLOCK
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(function tick(){
  const n=new Date();
  document.getElementById('clock').textContent=
    String(n.getHours()).padStart(2,'0')+':'+String(n.getMinutes()).padStart(2,'0');
  setTimeout(tick,10000);
})();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GRILLE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(function(){
  const g=document.getElementById('grille');
  [5,6,7,7,7,6,5].forEach(c=>{
    const row=document.createElement('div');row.className='grille-row';
    for(let i=0;i<c;i++){const d=document.createElement('div');d.className='grille-dot';row.appendChild(d);}
    g.appendChild(row);
  });
})();
let waveT=null;
function waveOn(){
  if(waveT)return;
  const dots=[...document.querySelectorAll('.grille-dot')];
  waveT=setInterval(()=>{
    dots.forEach(d=>d.classList.remove('lit'));
    const n=4+Math.floor(Math.random()*9);
    for(let i=0;i<n;i++)dots[Math.floor(Math.random()*dots.length)].classList.add('lit');
  },75);
}
function waveOff(){
  clearInterval(waveT);waveT=null;
  document.querySelectorAll('.grille-dot').forEach(d=>d.classList.remove('lit'));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TOAST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let toastTm;
function showToast(msg,ms=2800){
  const el=document.getElementById('toastEl');
  el.textContent=msg;el.classList.add('show');
  clearTimeout(toastTm);toastTm=setTimeout(()=>el.classList.remove('show'),ms);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  OVERLAYS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openOv(id){document.getElementById(id).classList.add('open');}
function closeOv(id){document.getElementById(id).classList.remove('open');}
function closeOvOut(e,id){if(e.target===document.getElementById(id))closeOv(id);}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  NUMPAD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let npBuf='';
function openNumpad(){npBuf='';document.getElementById('npDisplay').textContent='____';openOv('numpadOv');}
function np(d){
  if(npBuf.length>=4)return;
  npBuf+=String(d);
  document.getElementById('npDisplay').textContent=npBuf.padEnd(4,'_');
  if(npBuf.length===4)setTimeout(npOk,200);
}
function npDel(){npBuf=npBuf.slice(0,-1);document.getElementById('npDisplay').textContent=npBuf.padEnd(4,'_');}
function npOk(){
  if(npBuf.length<4){showToast('Enter 4 digits');return;}
  closeOv('numpadOv');tuneFreq(npBuf);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FREQUENCY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let currentFreq=null;
function changeFreq(d){
  let n=parseInt(currentFreq||'1000')+d;
  if(n<1000)n=9999;if(n>9999)n=1000;
  tuneFreq(String(n));
}
function tuneFreq(freq){
  if(freq===currentFreq)return;
  if(currentFreq)disconnect();
  currentFreq=freq;
  document.getElementById('freqDisplay').textContent=freq;
  initMyPeer();
  setStatus('READY');
  updatePeerUI();
  showToast('Freq '+freq+' â€” tap Invite to share');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PEER.JS STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let peer=null;           // my Peer object
let myPeerId=null;       // stable random peer id
let conns={};            // peerId -> DataConnection
let recording=false,mediaRec=null,audioChunks=[];
let inbound={};          // reassembly buffers

function getStoredPeerId(){
  let id=sessionStorage.getItem('wt_pid');
  if(!id){id='wt_'+Math.random().toString(36).substr(2,10);sessionStorage.setItem('wt_pid',id);}
  return id;
}

// â”€â”€â”€ TOKEN = first 8 chars of myPeerId â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// We encode our peer ID in the invite link.
// The token displayed to user is just the last 8 alphanumeric chars for readability.
function getMyToken(){return myPeerId?myPeerId.replace('wt_','').toUpperCase().substr(0,8):null;}
function peerIdFromToken(tok){
  // Guest connects directly to host's peer id
  // Host peer id = 'wt_' + lowercase token
  return 'wt_'+tok.toLowerCase();
}

// â”€â”€â”€ Init peer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initMyPeer(){
  if(peer&&!peer.destroyed)return;// already up

  myPeerId='wt_'+Math.random().toString(36).substr(2,10);
  // Store so guests can connect after page refresh isn't possible but keep consistent within session
  sessionStorage.setItem('wt_pid',myPeerId);

  peer=new Peer(myPeerId,{debug:0,config:{iceServers:[
    {urls:'stun:stun.l.google.com:19302'},
    {urls:'stun:stun1.l.google.com:19302'}
  ]}});

  peer.on('open',id=>{
    myPeerId=id;
    console.log('My peer id:',myPeerId);
  });

  peer.on('connection',conn=>{
    conn.on('open',()=>{
      if(Object.keys(conns).length>=3){
        sendTo(conn,{t:'full'});
        setTimeout(()=>conn.close(),500);
        return;
      }
      addConn(conn);
      // Tell new peer about existing peers (so they can also connect to them for full mesh)
      const others=Object.keys(conns).filter(p=>p!==conn.peer);
      sendTo(conn,{t:'welcome',freq:currentFreq,peers:others});
      // Tell everyone else
      broadcast({t:'joined',uid:conn.peer},conn.peer);
      showToast('ğŸ‘¤ Contact connected');
    });
  });

  peer.on('error',err=>{
    console.error('Peer error:',err.type,err);
    if(err.type==='unavailable-id'){
      // Try new id
      sessionStorage.removeItem('wt_pid');
      peer.destroy();peer=null;
      initMyPeer();
    }
  });
}

function addConn(conn){
  conns[conn.peer]=conn;
  conn.on('data',data=>onData(parse(data),conn.peer));
  conn.on('close',()=>{
    delete conns[conn.peer];
    removeGuestPeer(conn.peer);
    updatePeerUI();
    showToast('Contact disconnected');
  });
  conn.on('error',()=>{delete conns[conn.peer];removeGuestPeer(conn.peer);updatePeerUI();});
  updatePeerUI();
}

function disconnect(){
  Object.values(conns).forEach(c=>{try{c.close();}catch(e){}});
  conns={};
  if(peer&&!peer.destroyed){peer.destroy();peer=null;}
  guestPeers=[];
  setStatus('OFFLINE');
  updatePeerUI();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INVITE (host side)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openInviteModal(){
  if(!currentFreq){showToast('Set frequency first');return;}
  if(!peer||peer.destroyed)initMyPeer();

  document.getElementById('inviteFreqLabel').textContent=currentFreq;

  // Wait until peer is open
  const tryShow=()=>{
    if(!myPeerId){setTimeout(tryShow,200);return;}
    const tok=getMyToken();
    document.getElementById('tokenDisplay').textContent=tok;
    openOv('inviteOv');
  };
  tryShow();
}

function copyToken(){
  if(!myPeerId)return;
  const url=location.href.split('?')[0]+'?tok='+getMyToken();
  navigator.clipboard?.writeText(url)
    .then(()=>showToast('Link copied!'))
    .catch(()=>showToast('Token: '+getMyToken(),5000));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  JOIN (guest side)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Guest peers list (for mesh: guests also connect to each other)
let guestPeers=[];

function openJoinModal(){
  document.getElementById('joinInput').value='';
  document.getElementById('joinHint').textContent='Enter code to connect';
  openOv('joinOv');
  setTimeout(()=>document.getElementById('joinInput').focus(),300);
}

function joinInputHandler(el){
  el.value=el.value.replace(/[^0-9a-zA-Z]/g,'').toUpperCase().substr(0,8);
}

function joinByToken(){
  const tok=document.getElementById('joinInput').value.trim().toUpperCase();
  if(tok.length<8){showToast('Enter 8-character code');return;}
  closeOv('joinOv');
  connectToHost(tok);
}

function connectToHost(tok){
  if(!currentFreq){
    // Ask for frequency first â€” derive from token or ask user
    // For simplicity: open numpad, then connect
    showToast('Set your frequency first, then Join');
    openNumpad();
    pendingToken=tok;
    return;
  }
  doConnect(tok);
}

let pendingToken=null;

function doConnect(tok){
  setStatus('CONN...');
  if(!peer||peer.destroyed)initMyPeer();

  const hostId=peerIdFromToken(tok);
  console.log('Connecting to host:',hostId);

  // Wait for own peer to be open
  const tryConn=()=>{
    if(!myPeerId||peer.disconnected){setTimeout(tryConn,200);return;}
    const conn=peer.connect(hostId,{reliable:true,serialization:'raw'});
    let opened=false;

    conn.on('open',()=>{
      opened=true;
      addConn(conn);
      sendTo(conn,{t:'hello',uid:myPeerId,freq:currentFreq});
      setStatus('OPEN');
      showToast('Connected!');
    });
    conn.on('error',()=>{
      if(!opened){showToast('Cannot connect â€” check code');setStatus('READY');}
    });
    setTimeout(()=>{
      if(!opened){showToast('Timeout â€” check code');setStatus('READY');}
    },10000);
  };
  tryConn();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MESSAGE HANDLING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function onData(msg,fromPid){
  if(!msg)return;
  switch(msg.t){
    case'full': showToast('Channel full (max 4)');break;
    case'welcome':
      setStatus('OPEN');
      // Connect to other members for full mesh
      (msg.peers||[]).forEach(pid=>meshConnect(pid));
      updatePeerUI();
      break;
    case'hello': updatePeerUI();break;
    case'joined':
      if(!guestPeers.includes(msg.uid))guestPeers.push(msg.uid);
      updatePeerUI();break;
    case'left':
      removeGuestPeer(msg.uid);updatePeerUI();break;
    case'speaking':
      setPeerSpk(msg.uid,msg.on);
      // relay if we are host
      broadcastExcept(msg,[fromPid,msg.uid]);
      break;
    case'audio_chunk':
    case'audio_end':
      receiveChunk(msg);
      // relay to others
      broadcastExcept(msg,[fromPid]);
      break;
  }
}

function meshConnect(pid){
  if(conns[pid]||pid===myPeerId)return;
  const conn=peer.connect(pid,{reliable:true,serialization:'raw'});
  conn.on('open',()=>{addConn(conn);sendTo(conn,{t:'hello',uid:myPeerId});});
  conn.on('error',()=>{});
}

function removeGuestPeer(uid){
  guestPeers=guestPeers.filter(p=>p!==uid);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SEND HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function sendTo(conn,obj){
  try{conn.send(JSON.stringify(obj));}catch(e){}
}
function broadcast(obj,except){
  Object.entries(conns).forEach(([pid,c])=>{if(pid!==except)sendTo(c,obj);});
}
function broadcastExcept(obj,excepts){
  const ex=Array.isArray(excepts)?excepts:[excepts];
  Object.entries(conns).forEach(([pid,c])=>{if(!ex.includes(pid))sendTo(c,obj);});
}
function parse(data){
  try{
    if(typeof data==='string')return JSON.parse(data);
    if(data instanceof ArrayBuffer)return JSON.parse(new TextDecoder().decode(data));
    return data;
  }catch(e){return null;}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PTT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function pttDown(e){
  if(e)e.preventDefault();
  if(recording)return;
  if(!currentFreq){showToast('Set frequency first');return;}
  if(Object.keys(conns).length===0){showToast('No one connected');return;}
  if(document.querySelector('.peer-item.speaking')){showToast('Channel busy');return;}

  let stream;
  try{stream=await navigator.mediaDevices.getUserMedia({audio:true,video:false});}
  catch(err){showToast('Mic access denied');return;}

  recording=true;audioChunks=[];
  const mime=['audio/webm;codecs=opus','audio/webm','audio/ogg;codecs=opus','audio/mp4']
    .find(m=>MediaRecorder.isTypeSupported(m))||'';

  try{mediaRec=new MediaRecorder(stream,mime?{mimeType:mime}:{});}
  catch(e){mediaRec=new MediaRecorder(stream);}

  mediaRec.ondataavailable=ev=>{if(ev.data&&ev.data.size>0)audioChunks.push(ev.data);};
  mediaRec.onstop=()=>{
    stream.getTracks().forEach(t=>t.stop());
    if(!audioChunks.length){recording=false;resetPTT();return;}
    const blob=new Blob(audioChunks,{type:mediaRec.mimeType||'audio/webm'});
    sendAudio(blob,mediaRec.mimeType||'audio/webm');
  };

  mediaRec.start(200);
  setPtt('tx');waveOn();
  broadcast({t:'speaking',uid:myPeerId,on:true});
}

function pttUp(e){
  if(e)e.preventDefault();
  if(!recording)return;
  recording=false;
  if(mediaRec&&mediaRec.state!=='inactive')mediaRec.stop();
  broadcast({t:'speaking',uid:myPeerId,on:false});
  setPtt('sending');setLbl('SEND...');
}

async function sendAudio(blob,mime){
  try{
    const ab=await blob.arrayBuffer();
    const b64=ab2b64(ab);
    const CHUNK=6000;
    const total=Math.ceil(b64.length/CHUNK);
    showProg(true);
    for(let i=0;i<total;i++){
      broadcast({t:'audio_chunk',idx:i,total,chunk:b64.slice(i*CHUNK,(i+1)*CHUNK),mime});
      setProg((i+1)/total);
      await sleep(8);
    }
    broadcast({t:'audio_end',total,mime});
  }catch(err){showToast('Send error');console.error(err);}
  finally{showProg(false);resetPTT();}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RECEIVE AUDIO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function receiveChunk(msg){
  if(msg.t==='audio_chunk'){
    const key=msg.mime+'_'+msg.total;
    if(!inbound[key])inbound[key]={chunks:{},total:msg.total,mime:msg.mime};
    inbound[key].chunks[msg.idx]=msg.chunk;
    if(Object.keys(inbound[key].chunks).length===inbound[key].total){
      const ic=inbound[key];delete inbound[key];
      let b64='';for(let i=0;i<ic.total;i++)b64+=ic.chunks[i];
      playAudio(b64,ic.mime);
    }
  }
}

function playAudio(b64,mime){
  try{
    const raw=atob(b64);
    const arr=new Uint8Array(raw.length);
    for(let i=0;i<raw.length;i++)arr[i]=raw.charCodeAt(i);
    const blob=new Blob([arr],{type:mime||'audio/webm'});
    const url=URL.createObjectURL(blob);
    const audio=new Audio(url);

    setPtt('rx');waveOn();setLbl('RX...');

    const doPlay=()=>{
      audio.play().catch(err=>{
        console.error('playback err:',err);
        showToast('Tap to enable audio');
        document.addEventListener('touchstart',()=>audio.play(),{once:true});
        document.addEventListener('click',()=>audio.play(),{once:true});
      });
    };

    audio.oncanplaythrough=doPlay;
    audio.onended=()=>{URL.revokeObjectURL(url);resetPTT();waveOff();};
    audio.onerror=()=>{URL.revokeObjectURL(url);resetPTT();waveOff();};
  }catch(err){showToast('Audio error');console.error(err);resetPTT();}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SPEAKING INDICATOR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setPeerSpk(uid,on){
  const el=document.getElementById('peer_'+uid);
  if(el){
    if(on)el.classList.add('speaking');
    else el.classList.remove('speaking');
  }
  if(on&&uid!==myPeerId){setPtt('rx');waveOn();setLbl('RX...');}
  else if(!on&&!recording){resetPTT();waveOff();}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setPtt(s){const b=document.getElementById('pttBtn');b.classList.remove('tx','rx','sending');if(s)b.classList.add(s);}
function setLbl(t){document.getElementById('pttLabel').textContent=t;}
function resetPTT(){setPtt('');setLbl('TALK');waveOff();}
function showProg(on){document.getElementById('sendProg').classList.toggle('vis',on);if(!on)document.getElementById('sendBar').style.width='0%';}
function setProg(r){document.getElementById('sendBar').style.width=Math.round(r*100)+'%';}

function updatePeerUI(){
  const allPeers=Object.keys(conns);
  document.getElementById('peerCount').textContent=allPeers.length+1;
  const list=document.getElementById('peerList');
  if(!currentFreq){list.innerHTML='<div class="empty-peers">â€” set frequency to start â€”</div>';return;}
  if(allPeers.length===0){list.innerHTML='<div class="empty-peers">â€” waiting for contacts â€”</div>';return;}
  list.innerHTML=allPeers.map(pid=>{
    const short=(pid.replace('wt_','')).toUpperCase().substr(0,6);
    return`<div class="peer-item" id="peer_${pid}"><div class="peer-dot"></div><span>USER-${short}</span></div>`;
  }).join('');

  // Update status
  if(allPeers.length>0)setStatus('OPEN');
}

function setStatus(txt){
  const el=document.getElementById('statusLabel');
  el.textContent=txt;
  el.className='lcd-status'+((txt==='OPEN'||txt==='READY')?' on':'');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function ab2b64(ab){let s='';const b=new Uint8Array(ab);for(let i=0;i<b.byteLength;i++)s+=String.fromCharCode(b[i]);return btoa(s);}
function sleep(ms){return new Promise(r=>setTimeout(r,ms));}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  POWER BUTTON
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.getElementById('powerBtn').addEventListener('click',()=>{
  if(currentFreq){
    disconnect();currentFreq=null;
    document.getElementById('freqDisplay').textContent='----';
    document.getElementById('peerCount').textContent='0';
    showToast('Radio off');
  }else showToast('Set frequency to turn on');
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PTT touch â€” prevent scroll
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const pttEl=document.getElementById('pttBtn');
['touchstart','touchend','touchcancel'].forEach(ev=>
  pttEl.addEventListener(ev,e=>e.preventDefault(),{passive:false})
);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INVITE BUTTON â€” if no freq, show numpad; else invite modal
//  RIGHT CLICK / LONG PRESS â†’ join modal
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.getElementById('inviteBtn').addEventListener('contextmenu',e=>{
  e.preventDefault();openJoinModal();
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  URL PARAM: ?tok=XXXXXXXX  (auto-open join)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.addEventListener('load',()=>{
  const params=new URLSearchParams(location.search);
  const tok=params.get('tok');
  const freq=params.get('freq');

  if(tok){
    // Show join modal pre-filled
    if(freq&&/^\d{4}$/.test(freq)){
      tuneFreq(freq);
    }
    setTimeout(()=>{
      document.getElementById('joinInput').value=tok.toUpperCase();
      document.getElementById('joinHint').textContent='Ready to connect';
      openOv('joinOv');
    },600);
  } else if(freq&&/^\d{4}$/.test(freq)){
    setTimeout(()=>tuneFreq(freq),400);
  }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INVITE: encode freq in link too
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Override copyToken to include freq
function copyToken(){
  if(!myPeerId)return;
  const tok=getMyToken();
  const base=location.href.split('?')[0];
  const url=base+'?freq='+currentFreq+'&tok='+tok;
  navigator.clipboard?.writeText(url)
    .then(()=>showToast('Link copied!'))
    .catch(()=>{
      prompt('Copy this link:',url);
    });
}
</script>
</body>
</html>
