<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#1a8fd1">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="WalkieTalkie">
<meta name="application-name" content="WalkieTalkie">
<meta name="description" content="Push-to-talk walkie talkie over the internet">
<title>WalkieTalkie</title>

<!-- PWA manifest injected as blob so it works from a single HTML file -->
<script>
(function(){
  // Build manifest object — scope/start_url must match the page's actual origin+path
  const base = location.origin + location.pathname.replace(/\/[^/]*$/, '/');
  const manifest = {
    name: 'WalkieTalkie',
    short_name: 'WalkieTalkie',
    description: 'Push-to-talk walkie talkie',
    start_url: location.pathname + '?utm_source=pwa',
    scope: location.pathname.replace(/\/[^/]*$/, '/') || '/',
    display: 'standalone',
    orientation: 'portrait',
    background_color: '#1a8fd1',
    theme_color: '#1a8fd1',
    icons: [
      { src: _makeIcon(192,'#1a8fd1'), sizes:'192x192', type:'image/png', purpose:'any maskable' },
      { src: _makeIcon(512,'#1a8fd1'), sizes:'512x512', type:'image/png', purpose:'any maskable' }
    ]
  };

  // Build simple icon as data URI
  function _makeIcon(size, bg){
    const c = document.createElement('canvas');
    c.width = c.height = size;
    const ctx = c.getContext('2d');
    ctx.fillStyle = bg;
    ctx.fillRect(0,0,size,size);
    // Microphone icon
    const s = size/4;
    ctx.fillStyle = '#39ff14';
    ctx.beginPath();
    ctx.roundRect(size/2-s/2, size*0.15, s, s*1.4, s/2);
    ctx.fill();
    ctx.strokeStyle = '#39ff14';
    ctx.lineWidth = size*0.05;
    ctx.beginPath();
    ctx.arc(size/2, size*0.55, s*0.85, Math.PI, 0);
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(size/2, size*0.55+s*0.85);
    ctx.lineTo(size/2, size*0.78);
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(size/2-s*0.5, size*0.78);
    ctx.lineTo(size/2+s*0.5, size*0.78);
    ctx.stroke();
    return c.toDataURL('image/png');
  }

  const blob = new Blob([JSON.stringify(manifest)], {type:'application/manifest+json'});
  const url  = URL.createObjectURL(blob);
  const link = document.createElement('link');
  link.rel   = 'manifest';
  link.href  = url;
  document.currentScript.insertAdjacentElement('afterend', link);
})();
</script>

<!-- Service Worker registration (enables PWA install + offline cache) -->
<script>
(function(){
  if(!('serviceWorker' in navigator)) return;

  // Inline SW as blob — caches the page itself so it opens offline
  const swCode = `
const CACHE = 'wt-v1';
const SHELL = [self.registration.scope];

self.addEventListener('install', e => {
  e.waitUntil(
    caches.open(CACHE).then(c => c.addAll(SHELL)).then(() => self.skipWaiting())
  );
});

self.addEventListener('activate', e => {
  e.waitUntil(
    caches.keys().then(keys =>
      Promise.all(keys.filter(k => k !== CACHE).map(k => caches.delete(k)))
    ).then(() => self.clients.claim())
  );
});

// Network-first, fallback to cache
self.addEventListener('fetch', e => {
  if(e.request.method !== 'GET') return;
  e.respondWith(
    fetch(e.request)
      .then(r => { const c = r.clone(); caches.open(CACHE).then(cache => cache.put(e.request, c)); return r; })
      .catch(() => caches.match(e.request))
  );
});

// Handle push-to-foreground when notification/link clicked
self.addEventListener('notificationclick', e => { e.notification.close(); });
`;

  const swBlob = new Blob([swCode], {type: 'application/javascript'});
  const swUrl  = URL.createObjectURL(swBlob);

  navigator.serviceWorker.register(swUrl, {scope: './'})
    .then(reg => {
      console.log('[SW] registered scope:', reg.scope);
    })
    .catch(err => {
      // Blob-URL SW is blocked in some browsers (Firefox, Safari) — silently ignore.
      // The app still works; just won't cache for offline.
      console.info('[SW] registration skipped (blob SW not supported):', err.message);
    });
})();
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.5.2/peerjs.min.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Orbitron:wght@400;700;900&display=swap');

:root{
  --blue:#1a8fd1;--green:#39ff14;--gdark:#1db800;
  --lcd:#0f2200;--yellow:#ffd60a;--red:#ff3b30;
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
html,body{height:100%;overflow:hidden;}
body{
  background:var(--blue);font-family:'Share Tech Mono',monospace;
  display:flex;justify-content:center;
}
body::before{
  content:'';position:fixed;inset:0;pointer-events:none;z-index:0;
  background-image:radial-gradient(circle,rgba(255,255,255,.055) 1px,transparent 1px);
  background-size:18px 18px;
}

.device{
  width:100%;max-width:390px;height:100vh;
  background:linear-gradient(165deg,#2199d8 0%,#1478b8 45%,#0d6096 100%);
  display:flex;flex-direction:column;align-items:center;
  padding:20px 18px 40px;
  position:relative;z-index:1;overflow-y:auto;
}

/* top bar */
.topbar{width:100%;display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;flex-shrink:0;}
.clock{font-size:13px;color:rgba(255,255,255,.85);letter-spacing:1px;}
.install-btn{
  width:34px;height:34px;border-radius:8px;cursor:pointer;
  background:rgba(57,255,20,0.15);border:1.5px solid rgba(57,255,20,0.4);
  color:var(--green);display:flex;align-items:center;justify-content:center;
  transition:all .15s;box-shadow:0 0 8px rgba(57,255,20,.15);
}
.install-btn:active{transform:scale(.9);}
.install-btn:hover{background:rgba(57,255,20,.25);}

  width:40px;height:40px;border-radius:50%;cursor:pointer;flex-shrink:0;
  background:radial-gradient(circle at 38% 32%,#484848,#111);
  border:2px solid #444;display:flex;align-items:center;justify-content:center;
  box-shadow:0 3px 8px rgba(0,0,0,.55);transition:transform .1s;
}
.pwrbtn:active{transform:scale(.91);}
.pwricon{
  width:18px;height:18px;border:2.5px solid var(--green);border-radius:50%;
  border-top-color:transparent;position:relative;box-shadow:0 0 8px var(--green);
}
.pwricon::after{
  content:'';position:absolute;top:-5px;left:50%;transform:translateX(-50%);
  width:2.5px;height:8px;background:var(--green);box-shadow:0 0 6px var(--green);
}

/* LCD */
.lcd-panel{
  width:100%;background:#0a0a0a;border-radius:14px;padding:10px;
  box-shadow:0 5px 18px rgba(0,0,0,.65),inset 0 2px 5px rgba(0,0,0,.9);
  border:2px solid #0d0d0d;margin-bottom:6px;flex-shrink:0;
}
.lcd-screen{
  background:var(--lcd);border-radius:8px;padding:10px 14px;
  position:relative;overflow:hidden;cursor:pointer;
  box-shadow:inset 0 2px 10px rgba(0,0,0,.7),0 0 24px rgba(57,255,20,.1);
  min-height:68px;display:flex;align-items:center;justify-content:space-between;
}
.lcd-screen::after{
  content:'';position:absolute;inset:0;border-radius:8px;pointer-events:none;
  background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,0,0,.1) 2px,rgba(0,0,0,.1) 4px);
}
.lcd-freq{
  font-family:'Orbitron',monospace;font-size:44px;font-weight:900;
  color:var(--green);letter-spacing:5px;
  text-shadow:0 0 12px var(--green),0 0 35px rgba(57,255,20,.35);
  line-height:1;user-select:none;
}
.lcd-info{display:flex;flex-direction:column;align-items:flex-end;gap:5px;}
.lcd-count{font-family:'Orbitron',monospace;font-size:22px;font-weight:700;color:var(--green);text-shadow:0 0 8px var(--green);}
.lcd-status{font-size:10px;color:var(--gdark);letter-spacing:2px;}
.lcd-status.on{color:var(--green);text-shadow:0 0 6px var(--green);animation:blink 1.4s ease-in-out infinite;}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.35}}

.ctrl-row{display:grid;grid-template-columns:repeat(4,1fr);gap:6px;width:100%;padding:8px 0 2px;}
.cbtn{
  background:linear-gradient(150deg,#3c3c3e,#252527);border:none;border-radius:9px;color:#fff;
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  gap:3px;padding:10px 4px 8px;cursor:pointer;user-select:none;
  box-shadow:0 4px 7px rgba(0,0,0,.45),inset 0 1px 0 rgba(255,255,255,.07);transition:all .1s;
}
.cbtn:active{transform:scale(.92) translateY(1px);}
.cbtn svg{width:20px;height:20px;}
.cbtn span{font-size:10px;color:#999;letter-spacing:.5px;}

.divider{width:100%;height:1px;flex-shrink:0;background:linear-gradient(90deg,transparent,rgba(255,255,255,.14),transparent);margin:14px 0 10px;}

.sec-label{font-size:10px;color:rgba(255,255,255,.45);letter-spacing:2px;margin-bottom:7px;}
.peer-list{width:100%;display:flex;flex-direction:column;gap:5px;min-height:36px;}
.peer-item{
  display:flex;align-items:center;gap:10px;padding:7px 12px;
  background:rgba(0,0,0,.22);border-radius:9px;
  font-size:12px;color:rgba(255,255,255,.8);letter-spacing:1px;transition:background .2s;
}
.peer-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;background:var(--green);box-shadow:0 0 6px var(--green);transition:all .2s;}
.peer-item.speaking{background:rgba(255,213,10,.14);}
.peer-item.speaking .peer-dot{background:var(--yellow);box-shadow:0 0 8px var(--yellow);animation:spk .35s step-end infinite;}
@keyframes spk{50%{opacity:.15}}
.empty-peers{font-size:11px;color:rgba(255,255,255,.28);letter-spacing:1px;text-align:center;padding:8px 0;}

/* speaker */
.speaker-area{width:100%;flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:20px;padding:8px 0 4px;}
.speaker-wrapper{position:relative;width:100%;display:flex;justify-content:center;}
.grille{display:grid;gap:10px;}
.grow{display:flex;justify-content:center;gap:12px;}
.gdot{width:7px;height:7px;border-radius:50%;background:rgba(0,0,0,.38);box-shadow:inset 0 1px 2px rgba(0,0,0,.55);transition:background .07s;}
.gdot.lit{background:rgba(57,255,20,.55);box-shadow:0 0 5px var(--green);}
.spk-lbl{
  position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
  font-family:'Orbitron',monospace;font-size:11px;font-weight:700;
  color:rgba(255,255,255,.65);letter-spacing:3px;pointer-events:none;white-space:nowrap;
  text-shadow:0 1px 4px rgba(0,0,0,.6);
}

/* PTT */
.pttbtn{
  width:175px;height:64px;border-radius:32px;
  background:linear-gradient(155deg,#1e6eb4,#0c4e84);
  border:3px solid rgba(255,255,255,.16);color:#fff;
  font-family:'Orbitron',monospace;font-size:13px;font-weight:700;letter-spacing:2px;
  cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;
  box-shadow:0 7px 22px rgba(0,0,0,.45),inset 0 2px 4px rgba(255,255,255,.1);
  transition:all .12s;user-select:none;-webkit-user-select:none;touch-action:none;
  position:relative;overflow:hidden;flex-shrink:0;
}
.pttbtn::before{content:'';position:absolute;inset:0;border-radius:30px;background:linear-gradient(180deg,rgba(255,255,255,.09) 0%,transparent 60%);}
.pttbtn.tx{background:linear-gradient(155deg,#22a350,#14622e);border-color:var(--green);box-shadow:0 4px 12px rgba(0,0,0,.4),0 0 28px rgba(57,255,20,.45);transform:scale(.97) translateY(2px);}
.pttbtn.rx{background:linear-gradient(155deg,#b55800,#8a3c00);border-color:#ff9400;animation:rxp .65s ease-in-out infinite;}
.pttbtn.sending{background:linear-gradient(155deg,#2354aa,#183c7e);border-color:#5599ff;box-shadow:0 4px 12px rgba(0,0,0,.4),0 0 28px rgba(85,153,255,.4);}
@keyframes rxp{0%,100%{box-shadow:0 4px 12px rgba(0,0,0,.4),0 0 18px rgba(255,148,0,.3)}50%{box-shadow:0 4px 12px rgba(0,0,0,.4),0 0 42px rgba(255,148,0,.65)}}
.ptt-icon{width:22px;height:22px;flex-shrink:0;}

.progress{height:3px;width:100%;background:rgba(255,255,255,.08);border-radius:2px;overflow:hidden;display:none;margin-bottom:4px;flex-shrink:0;}
.progress.vis{display:block;}
.pbar{height:100%;background:linear-gradient(90deg,var(--green),#55aaff);border-radius:2px;width:0%;transition:width .08s;}

/* Toast */
.toast{
  position:fixed;top:22px;left:50%;transform:translateX(-50%) translateY(-90px);
  background:rgba(5,5,5,.92);color:#fff;padding:10px 22px;border-radius:22px;
  font-size:13px;letter-spacing:1px;transition:transform .3s cubic-bezier(.34,1.56,.64,1);
  z-index:600;white-space:nowrap;border:1px solid rgba(255,255,255,.09);backdrop-filter:blur(12px);
}
.toast.show{transform:translateX(-50%) translateY(0);}

/* Overlays */
.ov{
  position:fixed;inset:0;background:rgba(0,0,0,.78);
  display:flex;align-items:flex-end;justify-content:center;
  z-index:400;opacity:0;pointer-events:none;transition:opacity .2s;backdrop-filter:blur(5px);
}
.ov.open{opacity:1;pointer-events:all;}
.ov-mid{align-items:center;padding:20px;}

/* Numpad */
.numpad{
  background:linear-gradient(180deg,#1c1c1f,#101012);border-radius:22px 22px 0 0;
  padding:22px 16px 44px;width:100%;max-width:390px;
  box-shadow:0 -12px 44px rgba(0,0,0,.55);
}
.np-title{text-align:center;color:rgba(255,255,255,.45);font-size:11px;letter-spacing:3px;margin-bottom:14px;}
.np-disp{
  font-family:'Orbitron',monospace;font-size:44px;font-weight:900;
  color:var(--green);text-align:center;letter-spacing:9px;text-shadow:0 0 12px var(--green);
  margin-bottom:20px;min-height:60px;display:flex;align-items:center;justify-content:center;
}
.np-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:9px;}
.npbtn{
  background:linear-gradient(155deg,#2e2e30,#1c1c1e);border:none;border-radius:13px;
  color:#fff;font-family:'Orbitron',monospace;font-size:24px;font-weight:700;
  height:66px;cursor:pointer;user-select:none;
  box-shadow:0 4px 9px rgba(0,0,0,.45),inset 0 1px 0 rgba(255,255,255,.055);
  transition:all .1s;display:flex;align-items:center;justify-content:center;
}
.npbtn:active{transform:scale(.92);}
.npbtn.del{font-size:18px;color:var(--red);}
.npbtn.ok{background:linear-gradient(155deg,#1c7a3c,#0c5224);color:var(--green);font-size:13px;box-shadow:0 4px 9px rgba(0,0,0,.45),0 0 12px rgba(57,255,20,.18);}
.npbtn.ok:active{background:linear-gradient(155deg,#27b555,#196833);}

/* Modal box */
.mbox{
  background:linear-gradient(170deg,#1c1c1f,#101012);border-radius:20px;padding:26px 22px 28px;
  width:100%;max-width:340px;box-shadow:0 20px 60px rgba(0,0,0,.7);border:1px solid rgba(255,255,255,.07);
}
.mtitle{font-family:'Orbitron',monospace;font-size:13px;font-weight:700;color:var(--green);text-shadow:0 0 8px var(--green);letter-spacing:3px;margin-bottom:14px;text-align:center;}
.mdesc{font-size:12px;color:rgba(255,255,255,.5);letter-spacing:1px;line-height:1.6;margin-bottom:18px;text-align:center;}
.token-box{
  background:#0a0a0a;border-radius:12px;padding:14px 16px;
  font-family:'Orbitron',monospace;font-size:26px;font-weight:700;
  color:var(--green);letter-spacing:8px;text-align:center;
  text-shadow:0 0 10px var(--green);border:1px solid rgba(57,255,20,.2);
  margin-bottom:8px;cursor:pointer;
  box-shadow:inset 0 2px 8px rgba(0,0,0,.6),0 0 14px rgba(57,255,20,.08);
  user-select:all;
}
.token-hint{font-size:10px;color:rgba(255,255,255,.3);letter-spacing:1px;text-align:center;margin-bottom:18px;}
.mbtns{display:flex;gap:10px;}
.mbtn{flex:1;height:52px;border:none;border-radius:13px;cursor:pointer;font-family:'Orbitron',monospace;font-size:12px;font-weight:700;letter-spacing:1px;transition:all .12s;user-select:none;}
.mbtn.ok{background:linear-gradient(155deg,#1c7a3c,#0c5224);color:var(--green);box-shadow:0 4px 12px rgba(0,0,0,.4),0 0 16px rgba(57,255,20,.2);}
.mbtn.ok:active{transform:scale(.96);}
.mbtn.cancel{background:linear-gradient(155deg,#2e2e30,#1c1c1e);color:rgba(255,255,255,.6);box-shadow:0 4px 12px rgba(0,0,0,.4);}
.mbtn.cancel:active{transform:scale(.96);}

/* Token input */
.tinput{
  width:100%;background:#0a0a0a;border:1px solid rgba(57,255,20,.25);border-radius:12px;
  padding:14px 16px;font-family:'Orbitron',monospace;font-size:22px;font-weight:700;
  color:var(--green);letter-spacing:6px;text-align:center;outline:none;
  margin-bottom:6px;text-shadow:0 0 8px var(--green);
  box-shadow:inset 0 2px 8px rgba(0,0,0,.6);-webkit-appearance:none;
}
.tinput::placeholder{color:rgba(57,255,20,.2);letter-spacing:4px;}
.tinput:focus{border-color:rgba(57,255,20,.5);}
.thint{font-size:11px;color:rgba(255,255,255,.35);letter-spacing:1px;text-align:center;margin-bottom:16px;}
</style>
</head>
<body>
<div class="device">
  <div class="topbar">
    <div class="clock" id="clock">00:00</div>
    <div style="display:flex;gap:8px;align-items:center;">
      <button class="install-btn" id="installBtn" style="display:none" onclick="installPWA()" title="Install app">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
          <path d="M12 2v13M7 11l5 5 5-5"/><rect x="3" y="18" width="18" height="3" rx="1"/>
        </svg>
      </button>
      <div class="pwrbtn" id="pwrBtn"><div class="pwricon"></div></div>
    </div>
  </div>

  <div class="lcd-panel">
    <div class="lcd-screen" onclick="openNumpad()">
      <div class="lcd-freq" id="freqDisp">----</div>
      <div class="lcd-info">
        <div class="lcd-count" id="peerCount">0</div>
        <div class="lcd-status" id="statusLbl">OFFLINE</div>
      </div>
    </div>
    <div class="ctrl-row">
      <button class="cbtn" onclick="openNumpad()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
        <span>Mode</span>
      </button>
      <button class="cbtn" onclick="changeFreq(-1)">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="6 9 12 15 18 9"/></svg>
        <span>Down</span>
      </button>
      <button class="cbtn" onclick="changeFreq(1)">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="6 15 12 9 18 15"/></svg>
        <span>Up</span>
      </button>
      <button class="cbtn" onclick="openInvite()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg>
        <span>Invite</span>
      </button>
    </div>
  </div>

  <div class="divider"></div>

  <div style="width:100%">
    <div class="sec-label">USERS ON CHANNEL</div>
    <div class="peer-list" id="peerList"><div class="empty-peers">— set frequency to start —</div></div>
  </div>

  <div class="divider"></div>
  <div class="progress" id="prog"><div class="pbar" id="pbar"></div></div>

  <div class="speaker-area">
    <div class="speaker-wrapper">
      <div class="grille" id="grille"></div>
      <div class="spk-lbl">PUSH TO TALK</div>
    </div>
    <button class="pttbtn" id="pttBtn"
      onmousedown="pttDown()" onmouseup="pttUp()" onmouseleave="pttUp()"
      ontouchstart="pttDown(event)" ontouchend="pttUp(event)" ontouchcancel="pttUp(event)">
      <svg class="ptt-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/>
        <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
        <line x1="12" y1="19" x2="12" y2="23"/>
        <line x1="8" y1="23" x2="16" y2="23"/>
      </svg>
      <span id="pttLbl">TALK</span>
    </button>
  </div>
</div>

<!-- Numpad overlay -->
<div class="ov" id="npOv" onclick="if(event.target===this)closeOv('npOv')">
  <div class="numpad">
    <div class="np-title">ENTER FREQUENCY</div>
    <div class="np-disp" id="npDisp">____</div>
    <div class="np-grid">
      <button class="npbtn" onclick="npKey(1)">1</button>
      <button class="npbtn" onclick="npKey(2)">2</button>
      <button class="npbtn" onclick="npKey(3)">3</button>
      <button class="npbtn" onclick="npKey(4)">4</button>
      <button class="npbtn" onclick="npKey(5)">5</button>
      <button class="npbtn" onclick="npKey(6)">6</button>
      <button class="npbtn" onclick="npKey(7)">7</button>
      <button class="npbtn" onclick="npKey(8)">8</button>
      <button class="npbtn" onclick="npKey(9)">9</button>
      <button class="npbtn del" onclick="npDel()">&#9003;</button>
      <button class="npbtn" onclick="npKey(0)">0</button>
      <button class="npbtn ok" onclick="npOk()">TUNE</button>
    </div>
  </div>
</div>

<!-- Invite (host) modal -->
<div class="ov ov-mid" id="invOv" onclick="if(event.target===this)closeOv('invOv')">
  <div class="mbox">
    <div class="mtitle">INVITE · FREQ <span id="invFreq">----</span></div>
    <div class="mdesc">Share this code. Friend taps Invite → Join and enters it.</div>
    <div class="token-box" id="tokenDisp" onclick="doCopyLink()">--------</div>
    <div class="token-hint">Tap code to copy invite link</div>
    <div class="mbtns">
      <button class="mbtn ok" onclick="doCopyLink()">Copy link</button>
      <button class="mbtn cancel" onclick="closeOv('invOv')">Close</button>
    </div>
  </div>
</div>

<!-- Join (guest) modal -->
<div class="ov ov-mid" id="joinOv" onclick="if(event.target===this)closeOv('joinOv')">
  <div class="mbox">
    <div class="mtitle">JOIN CHANNEL</div>
    <div class="mdesc">Enter the code from your contact's invite link</div>
    <input class="tinput" id="joinInput" maxlength="8" placeholder="00000000"
      oninput="this.value=this.value.replace(/[^0-9a-zA-Z]/g,'').toUpperCase().slice(0,8)"
      inputmode="text" autocomplete="off" autocorrect="off" spellcheck="false"/>
    <div class="thint" id="joinHint">8-character code</div>
    <div class="mbtns">
      <button class="mbtn ok" onclick="doJoin()">Connect</button>
      <button class="mbtn cancel" onclick="closeOv('joinOv')">Cancel</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
/* ══════════════════════════════════════════════════════════
   CLOCK
══════════════════════════════════════════════════════════ */
(function tick(){
  const n=new Date();
  document.getElementById('clock').textContent=
    n.getHours().toString().padStart(2,'0')+':'+n.getMinutes().toString().padStart(2,'0');
  setTimeout(tick,10000);
})();

/* ══════════════════════════════════════════════════════════
   GRILLE
══════════════════════════════════════════════════════════ */
(function(){
  const g=document.getElementById('grille');
  [5,6,7,7,7,6,5].forEach(c=>{
    const r=document.createElement('div');r.className='grow';
    for(let i=0;i<c;i++){const d=document.createElement('div');d.className='gdot';r.appendChild(d);}
    g.appendChild(r);
  });
})();
let waveTimer=null;
function waveOn(){
  if(waveTimer)return;
  const dots=[...document.querySelectorAll('.gdot')];
  waveTimer=setInterval(()=>{
    dots.forEach(d=>d.classList.remove('lit'));
    for(let i=0,n=4+Math.floor(Math.random()*9);i<n;i++)
      dots[Math.floor(Math.random()*dots.length)].classList.add('lit');
  },75);
}
function waveOff(){clearInterval(waveTimer);waveTimer=null;document.querySelectorAll('.gdot').forEach(d=>d.classList.remove('lit'));}

/* ══════════════════════════════════════════════════════════
   TOAST
══════════════════════════════════════════════════════════ */
let toastT;
function toast(msg,ms=2800){
  const el=document.getElementById('toast');
  el.textContent=msg;el.classList.add('show');
  clearTimeout(toastT);toastT=setTimeout(()=>el.classList.remove('show'),ms);
}

/* ══════════════════════════════════════════════════════════
   OVERLAY HELPERS
══════════════════════════════════════════════════════════ */
function openOv(id){document.getElementById(id).classList.add('open');}
function closeOv(id){document.getElementById(id).classList.remove('open');}

/* ══════════════════════════════════════════════════════════
   NUMPAD
══════════════════════════════════════════════════════════ */
let npBuf='';
function openNumpad(){npBuf='';upNpDisp();openOv('npOv');}
function upNpDisp(){document.getElementById('npDisp').textContent=(npBuf||'').padEnd(4,'_');}
function npKey(d){if(npBuf.length>=4)return;npBuf+=String(d);upNpDisp();if(npBuf.length===4)setTimeout(npOk,200);}
function npDel(){npBuf=npBuf.slice(0,-1);upNpDisp();}
function npOk(){if(npBuf.length<4){toast('Enter 4 digits');return;}closeOv('npOv');tuneFreq(npBuf);}

/* ══════════════════════════════════════════════════════════
   FREQUENCY
══════════════════════════════════════════════════════════ */
let currentFreq=null;
function changeFreq(d){
  let n=parseInt(currentFreq||'1000')+d;
  if(n<1000)n=9999;if(n>9999)n=1000;tuneFreq(String(n));
}
function tuneFreq(freq){
  if(freq===currentFreq)return;
  if(currentFreq)hardDisconnect();
  currentFreq=freq;
  document.getElementById('freqDisp').textContent=freq;
  // Start peer so my ID is ready when user hits Invite
  startPeer().then(()=>{
    setStatus('READY');
    updateUI();
  });
}

/* ══════════════════════════════════════════════════════════
   PEER ENGINE
   -  myPeer: Peer object
   -  myId:   string peer id assigned by PeerJS
   -  conns:  { peerId: DataConnection }
══════════════════════════════════════════════════════════ */
let myPeer=null, myId=null, conns={};
let recording=false, mediaRec=null, audioChunks=[];
let inbuf={};  // audio reassembly

/* Start (or reuse) peer — returns Promise resolved when open */
function startPeer(){
  return new Promise(resolve=>{
    if(myPeer && !myPeer.destroyed && myId){resolve();return;}
    if(myPeer && !myPeer.destroyed){myPeer.destroy();}

    // Random short ID — no need for guessable name
    const id='wt'+Math.random().toString(36).slice(2,10);
    const p=new Peer(id,{debug:0,config:{iceServers:[
      {urls:'stun:stun.l.google.com:19302'},
      {urls:'stun:stun1.l.google.com:19302'}
    ]}});

    p.on('open',assignedId=>{
      myPeer=p; myId=assignedId;
      console.log('[WT] My peer ID:',myId);
      resolve();
    });

    p.on('connection',incoming=>{
      incoming.on('open',()=>onIncomingOpen(incoming));
    });

    p.on('error',err=>{
      console.error('[WT] peer error',err.type,err.message);
      if(err.type==='unavailable-id'){
        // Rare — retry with new random id
        p.destroy();myPeer=null;myId=null;
        startPeer().then(resolve);
      } else {
        toast('Network error: '+err.type);
        resolve(); // resolve anyway so callers don't hang
      }
    });

    p.on('disconnected',()=>{
      console.warn('[WT] peer disconnected — reconnecting');
      p.reconnect();
    });
  });
}

/* Host receives guest connection */
function onIncomingOpen(conn){
  const pid=conn.peer;
  if(Object.keys(conns).length>=3){
    sendMsg(conn,{t:'full'});
    setTimeout(()=>conn.close(),400);
    return;
  }
  registerConn(conn);
  // Tell guest who else is in the channel
  sendMsg(conn,{t:'welcome',peers:Object.keys(conns).filter(p=>p!==pid)});
  // Tell others a new peer joined
  broadcastExcept({t:'joined',uid:pid},pid);
  toast('Contact connected');
  updateUI();
}

/* Register a DataConnection both ways */
function registerConn(conn){
  const pid=conn.peer;
  conns[pid]=conn;
  conn.on('data',raw=>handleMsg(parseMsg(raw),pid));
  conn.on('close',()=>{
    delete conns[pid];
    broadcast({t:'left',uid:pid});
    updateUI();
    toast('Contact disconnected');
  });
  conn.on('error',err=>{
    console.error('[WT] conn error',pid,err);
    delete conns[pid];updateUI();
  });
}

/* Connect to a peer by ID — returns Promise */
function connectTo(targetId){
  return new Promise((resolve,reject)=>{
    if(conns[targetId]){resolve();return;} // already connected
    console.log('[WT] Connecting to',targetId);
    const conn=myPeer.connect(targetId,{reliable:true,serialization:'raw'});
    let done=false;
    const fail=reason=>{if(done)return;done=true;reject(new Error(reason));};
    conn.on('open',()=>{
      if(done)return;done=true;
      registerConn(conn);
      sendMsg(conn,{t:'hello',uid:myId,freq:currentFreq});
      resolve();
    });
    conn.on('error',err=>fail(err.message||'conn error'));
    setTimeout(()=>fail('timeout'),12000);
  });
}

function hardDisconnect(){
  Object.values(conns).forEach(c=>{try{c.close();}catch(_){}});
  conns={};
  if(myPeer&&!myPeer.destroyed){myPeer.destroy();}
  myPeer=null;myId=null;
  setStatus('OFFLINE');updateUI();
}

/* ══════════════════════════════════════════════════════════
   TOKEN  (host shares this; guest enters it)
   Token = peer ID itself, encoded as uppercase base36-ish
   We just use the random suffix of myId (8 chars after 'wt')
══════════════════════════════════════════════════════════ */
function myToken(){
  // myId looks like "wtXXXXXXXX" — token is the 8 chars after "wt"
  return myId ? myId.slice(2).toUpperCase() : null;
}
function peerIdFromToken(tok){
  return 'wt'+tok.toLowerCase();
}

/* ══════════════════════════════════════════════════════════
   INVITE MODAL (host)
══════════════════════════════════════════════════════════ */
function openInvite(){
  if(!currentFreq){toast('Set frequency first');return;}
  setStatus('WAIT...');
  startPeer().then(()=>{
    setStatus('READY');
    document.getElementById('invFreq').textContent=currentFreq;
    document.getElementById('tokenDisp').textContent=myToken();
    openOv('invOv');
  });
}

function doCopyLink(){
  const tok=myToken();
  if(!tok)return;
  const url=location.href.split('?')[0]+'?freq='+currentFreq+'&tok='+tok;
  if(navigator.clipboard){
    navigator.clipboard.writeText(url)
      .then(()=>toast('Link copied!'))
      .catch(()=>fallbackCopy(url));
  } else fallbackCopy(url);
}
function fallbackCopy(url){
  try{
    const ta=document.createElement('textarea');
    ta.value=url;ta.style.position='fixed';ta.style.opacity='0';
    document.body.appendChild(ta);ta.focus();ta.select();
    document.execCommand('copy');document.body.removeChild(ta);
    toast('Link copied!');
  }catch(_){prompt('Copy this link:',url);}
}

/* ══════════════════════════════════════════════════════════
   JOIN MODAL (guest)
══════════════════════════════════════════════════════════ */
function openJoin(){
  document.getElementById('joinInput').value='';
  document.getElementById('joinHint').textContent='8-character code';
  openOv('joinOv');
  setTimeout(()=>document.getElementById('joinInput').focus(),300);
}

async function doJoin(){
  const tok=document.getElementById('joinInput').value.trim().toUpperCase();
  if(tok.length<8){toast('Enter full 8-character code');return;}
  closeOv('joinOv');
  setStatus('CONN...');

  if(!currentFreq){
    // Ask for frequency
    toast('Set frequency first');openNumpad();
    // Store pending
    sessionStorage.setItem('pendingTok',tok);
    return;
  }

  await startPeer();
  const hostId=peerIdFromToken(tok);
  console.log('[WT] Joining host:',hostId);

  try{
    await connectTo(hostId);
    setStatus('OPEN');
    toast('Connected!');
    updateUI();
  }catch(err){
    console.error('[WT] join failed:',err);
    toast('Cannot connect — check code or ask host to reload');
    setStatus('READY');
  }
}

/* ══════════════════════════════════════════════════════════
   MESSAGE HANDLING
══════════════════════════════════════════════════════════ */
function handleMsg(msg,fromPid){
  if(!msg)return;
  switch(msg.t){
    case'full':
      toast('Channel full (max 4 users)');break;

    case'welcome':
      setStatus('OPEN');updateUI();
      // Connect to other members already in channel (mesh)
      (msg.peers||[]).forEach(pid=>meshConnect(pid));
      break;

    case'hello':
      updateUI();
      if(Object.keys(conns).length>0)setStatus('OPEN');
      break;

    case'joined':
      // Another peer joined — connect to them too
      meshConnect(msg.uid);
      updateUI();
      break;

    case'left':
      delete conns[msg.uid];updateUI();break;

    case'speaking':
      markSpeaking(msg.uid,msg.on);
      if(!msg._r)broadcastExcept(Object.assign({},msg,{_r:1}),fromPid);
      break;

    case'audio_chunk':
    case'audio_done':
      // Relay to others only if not already a relayed copy (prevents loops + duplicates)
      if(!msg._r){
        broadcastExcept(Object.assign({},msg,{_r:1}),fromPid);
      }
      receiveChunk(msg);
      break;
  }
}

/* Mesh: connect to a peer we don't yet know */
async function meshConnect(pid){
  if(!pid||pid===myId||conns[pid])return;
  try{
    await connectTo(pid);
    sendMsg(conns[pid],{t:'hello',uid:myId,freq:currentFreq});
    updateUI();
  }catch(e){console.warn('[WT] mesh connect failed',pid,e.message);}
}

/* ══════════════════════════════════════════════════════════
   MESSAGING UTILS
══════════════════════════════════════════════════════════ */
function sendMsg(conn,obj){try{conn.send(JSON.stringify(obj));}catch(e){console.warn('send err',e);}}
function broadcast(obj){Object.values(conns).forEach(c=>sendMsg(c,obj));}
function broadcastExcept(obj,exceptPid){Object.entries(conns).forEach(([pid,c])=>{if(pid!==exceptPid)sendMsg(c,obj);});}
function parseMsg(raw){
  try{
    if(typeof raw==='string')return JSON.parse(raw);
    if(raw instanceof ArrayBuffer)return JSON.parse(new TextDecoder().decode(raw));
    return raw;
  }catch(e){return null;}
}

/* ══════════════════════════════════════════════════════════
   PTT
══════════════════════════════════════════════════════════ */
async function pttDown(e){
  if(e)e.preventDefault();
  if(recording)return;
  if(!currentFreq){toast('Set frequency first');return;}
  if(Object.keys(conns).length===0){toast('Nobody connected');return;}
  if(document.querySelector('.peer-item.speaking')){toast('Channel busy');return;}

  let stream;
  try{stream=await navigator.mediaDevices.getUserMedia({audio:true,video:false});}
  catch(_){toast('Microphone access denied');return;}

  recording=true;audioChunks=[];

  // Pick best supported mime type
  const mime=['audio/webm;codecs=opus','audio/webm','audio/ogg;codecs=opus','audio/mp4']
    .find(m=>MediaRecorder.isTypeSupported(m))||'';

  try{mediaRec=new MediaRecorder(stream,mime?{mimeType:mime}:{});}
  catch(_){mediaRec=new MediaRecorder(stream);}

  mediaRec.ondataavailable=ev=>{
    if(ev.data&&ev.data.size>0)audioChunks.push(ev.data);
  };

  mediaRec.onstop=()=>{
    stream.getTracks().forEach(t=>t.stop());
    if(!audioChunks.length){recording=false;resetPTT();return;}
    const finalMime=mediaRec.mimeType||mime||'audio/webm';
    const blob=new Blob(audioChunks,{type:finalMime});
    console.log('[WT] recorded blob',blob.size,'bytes mime=',finalMime);
    sendAudio(blob,finalMime);
  };

  // timeslice=100ms gives frequent ondataavailable events
  mediaRec.start(100);
  setPtt('tx');waveOn();
  broadcast({t:'speaking',uid:myId,on:true});
}

function pttUp(e){
  if(e)e.preventDefault();
  if(!recording)return;
  recording=false;
  broadcast({t:'speaking',uid:myId,on:false});
  setPtt('sending');setLbl('SEND...');

  if(mediaRec&&mediaRec.state==='recording'){
    // requestData flushes the last buffered chunk before stop fires onstop
    try{mediaRec.requestData();}catch(_){}
    mediaRec.stop();
  }
}

async function sendAudio(blob,mime){
  try{
    // FIX 1: safe large-buffer base64 that won't stack-overflow
    const ab=await blob.arrayBuffer();
    const b64=safeAb2b64(ab);
    console.log('[WT] sending b64 length=',b64.length);

    // FIX 2: unique msgId per transmission so reassembly keys never collide
    const msgId=Date.now().toString(36)+Math.random().toString(36).slice(2,6);
    const SZ=8000;  // larger chunks = fewer messages
    const total=Math.ceil(b64.length/SZ)||1;

    showProg(true);
    for(let i=0;i<total;i++){
      broadcast({t:'audio_chunk',id:msgId,i,total,d:b64.slice(i*SZ,(i+1)*SZ),mime});
      setProg((i+1)/total);
      // small yield so DataChannel isn't flooded
      if(i%5===4)await sleep(10);
    }
    broadcast({t:'audio_done',id:msgId,total,mime});
    console.log('[WT] sent',total,'chunks');
  }catch(err){toast('Send error');console.error('[WT] sendAudio err',err);}
  finally{showProg(false);resetPTT();}
}

/* ══════════════════════════════════════════════════════════
   RECEIVE AUDIO
══════════════════════════════════════════════════════════ */
// FIX 3: keyed by unique msgId, with stale-buffer cleanup timeout
const CHUNK_TIMEOUT_MS=20000;

function receiveChunk(msg){
  if(msg.t!=='audio_chunk'&&msg.t!=='audio_done')return;

  const key=msg.id;
  if(!key)return;

  if(msg.t==='audio_chunk'){
    if(!inbuf[key]){
      inbuf[key]={chunks:{},total:msg.total,mime:msg.mime,
        timer:setTimeout(()=>{console.warn('[WT] chunk timeout, dropping',key);delete inbuf[key];},CHUNK_TIMEOUT_MS)
      };
    }
    inbuf[key].chunks[msg.i]=msg.d;
    const received=Object.keys(inbuf[key].chunks).length;
    if(received===inbuf[key].total){
      clearTimeout(inbuf[key].timer);
      const ic=inbuf[key];delete inbuf[key];
      // reassemble in order
      let b64='';
      for(let i=0;i<ic.total;i++)b64+=ic.chunks[i]||'';
      console.log('[WT] reassembled b64 length=',b64.length,'mime=',ic.mime);
      playAudio(b64,ic.mime);
    }
  }
  // audio_done: if we somehow missed the count-based trigger, try anyway
  if(msg.t==='audio_done'&&inbuf[key]){
    const ic=inbuf[key];
    const received=Object.keys(ic.chunks).length;
    if(received>0&&received>=ic.total*0.9){
      clearTimeout(ic.timer);delete inbuf[key];
      let b64='';
      for(let i=0;i<ic.total;i++)b64+=ic.chunks[i]||'';
      playAudio(b64,ic.mime);
    }
  }
}

// FIX 4: robust playback — don't rely solely on oncanplaythrough
function playAudio(b64,mime){
  if(!b64||!b64.length){console.warn('[WT] empty b64, skip');return;}
  try{
    // safe base64 decode
    const raw=atob(b64);
    const arr=new Uint8Array(raw.length);
    for(let i=0;i<raw.length;i++)arr[i]=raw.charCodeAt(i);
    const url=URL.createObjectURL(new Blob([arr],{type:mime||'audio/webm'}));

    const audio=new Audio(url);
    audio.preload='auto';

    setPtt('rx');waveOn();setLbl('RX...');

    const cleanup=()=>{URL.revokeObjectURL(url);resetPTT();waveOff();};

    const tryPlay=()=>{
      audio.play().catch(err=>{
        console.warn('[WT] autoplay blocked:',err.name);
        // Show tap-to-play hint; resume on next user interaction
        toast('Tap anywhere to hear message');
        const resume=()=>{
          audio.play().catch(e=>console.warn('[WT] resume failed',e));
          document.removeEventListener('touchstart',resume);
          document.removeEventListener('click',resume);
        };
        document.addEventListener('touchstart',resume,{once:true});
        document.addEventListener('click',resume,{once:true});
      });
    };

    audio.onended=cleanup;
    audio.onerror=e=>{console.error('[WT] audio onerror',e,audio.error);cleanup();toast('Playback error');};

    // FIX: fire play on both events + immediately (blob URLs are often ready instantly)
    audio.oncanplay=tryPlay;
    audio.onloadeddata=tryPlay;
    audio.load(); // explicitly kick off loading
    // Also try right away after a short tick in case events already fired
    setTimeout(()=>{if(audio.paused&&audio.readyState>=2)tryPlay();},80);

  }catch(err){toast('Audio decode error');console.error('[WT] playAudio err',err);resetPTT();}
}

/* ══════════════════════════════════════════════════════════
   SPEAKING INDICATOR
══════════════════════════════════════════════════════════ */
function markSpeaking(uid,on){
  document.querySelectorAll('.peer-item').forEach(el=>{
    if(el.id==='peer_'+uid){if(on)el.classList.add('speaking');else el.classList.remove('speaking');}
  });
  if(on&&uid!==myId){setPtt('rx');waveOn();setLbl('RX...');}
  else if(!on&&!recording){resetPTT();waveOff();}
}

/* ══════════════════════════════════════════════════════════
   UI HELPERS
══════════════════════════════════════════════════════════ */
function setPtt(s){const b=document.getElementById('pttBtn');b.classList.remove('tx','rx','sending');if(s)b.classList.add(s);}
function setLbl(t){document.getElementById('pttLbl').textContent=t;}
function resetPTT(){setPtt('');setLbl('TALK');waveOff();}
function showProg(on){document.getElementById('prog').classList.toggle('vis',on);if(!on)document.getElementById('pbar').style.width='0%';}
function setProg(r){document.getElementById('pbar').style.width=Math.round(r*100)+'%';}

function setStatus(txt){
  const el=document.getElementById('statusLbl');
  el.textContent=txt;
  el.className='lcd-status'+((txt==='OPEN'||txt==='READY')?' on':'');
}

function updateUI(){
  const peers=Object.keys(conns);
  document.getElementById('peerCount').textContent=peers.length+1;
  const list=document.getElementById('peerList');
  if(!currentFreq){list.innerHTML='<div class="empty-peers">— set frequency to start —</div>';return;}
  if(!peers.length){list.innerHTML='<div class="empty-peers">— waiting for contacts —</div>';return;}
  list.innerHTML=peers.map(pid=>{
    const label=pid.slice(2,8).toUpperCase();
    return`<div class="peer-item" id="peer_${pid}"><div class="peer-dot"></div><span>USER-${label}</span></div>`;
  }).join('');
  if(peers.length>0)setStatus('OPEN');
}

/* ══════════════════════════════════════════════════════════
   UTILS
══════════════════════════════════════════════════════════ */
// Safe base64: chunked fromCharCode avoids stack overflow on large buffers
function safeAb2b64(ab){
  const bytes=new Uint8Array(ab),STEP=8192;
  let s='';
  for(let i=0;i<bytes.length;i+=STEP)
    s+=String.fromCharCode.apply(null,bytes.subarray(i,i+STEP));
  return btoa(s);
}
function ab2b64(ab){return safeAb2b64(ab);}
function sleep(ms){return new Promise(r=>setTimeout(r,ms));}

/* ══════════════════════════════════════════════════════════
   PWA INSTALL PROMPT
══════════════════════════════════════════════════════════ */
let _deferredInstall = null;

window.addEventListener('beforeinstallprompt', e => {
  e.preventDefault();
  _deferredInstall = e;
  document.getElementById('installBtn').style.display = 'flex';
  console.log('[PWA] install prompt ready');
});

window.addEventListener('appinstalled', () => {
  _deferredInstall = null;
  document.getElementById('installBtn').style.display = 'none';
  toast('App installed!');
});

function installPWA(){
  if(!_deferredInstall){ toast('Use browser menu → Add to Home Screen'); return; }
  _deferredInstall.prompt();
  _deferredInstall.userChoice.then(result => {
    if(result.outcome==='accepted') toast('Installing...');
    _deferredInstall = null;
    document.getElementById('installBtn').style.display = 'none';
  });
}

/* ══════════════════════════════════════════════════════════
   POWER BUTTON
══════════════════════════════════════════════════════════ */
document.getElementById('pwrBtn').addEventListener('click',()=>{
  if(currentFreq){
    hardDisconnect();currentFreq=null;
    document.getElementById('freqDisp').textContent='----';
    document.getElementById('peerCount').textContent='0';
    toast('Radio off');
  }else toast('Set frequency to turn on');
});

/* ══════════════════════════════════════════════════════════
   PTT TOUCH — prevent scroll
══════════════════════════════════════════════════════════ */
['touchstart','touchend','touchcancel'].forEach(ev=>
  document.getElementById('pttBtn').addEventListener(ev,e=>e.preventDefault(),{passive:false})
);

/* ══════════════════════════════════════════════════════════
   INVITE BUTTON — tap = host invite; long-press = guest join
══════════════════════════════════════════════════════════ */
let longPressT=null;
const invBtn=document.querySelector('.cbtn:last-child');
invBtn.addEventListener('touchstart',()=>{longPressT=setTimeout(()=>{longPressT=null;openJoin();},600);},{passive:true});
invBtn.addEventListener('touchend',()=>{if(longPressT){clearTimeout(longPressT);longPressT=null;}},{passive:true});
invBtn.addEventListener('contextmenu',e=>{e.preventDefault();openJoin();});

/* ══════════════════════════════════════════════════════════
   URL PARAMS — auto-join when link opened
   ?freq=1234&tok=XXXXXXXX
══════════════════════════════════════════════════════════ */
window.addEventListener('load',async()=>{
  const p=new URLSearchParams(location.search);
  const tok=p.get('tok');
  const freq=p.get('freq');

  // Check pending token from pre-freq flow
  const pending=sessionStorage.getItem('pendingTok');
  if(pending){sessionStorage.removeItem('pendingTok');}

  const finalTok=tok||pending;

  if(finalTok){
    // Set freq first if provided
    if(freq&&/^\d{4}$/.test(freq)){
      currentFreq=freq;
      document.getElementById('freqDisp').textContent=freq;
      await startPeer();
      setStatus('READY');updateUI();
    }
    // Auto-open join modal with token pre-filled and auto-connect
    document.getElementById('joinInput').value=finalTok.toUpperCase();
    document.getElementById('joinHint').textContent='Ready — tap Connect';
    openOv('joinOv');

    // If freq is set, auto-connect after a short delay so user sees what's happening
    if(freq&&/^\d{4}$/.test(freq)){
      setTimeout(async()=>{
        closeOv('joinOv');
        setStatus('CONN...');
        await startPeer();
        const hostId=peerIdFromToken(finalTok);
        console.log('[WT] auto-joining host:',hostId);
        try{
          await connectTo(hostId);
          setStatus('OPEN');toast('Connected!');updateUI();
        }catch(err){
          console.error('[WT] auto-join failed:',err);
          // Re-open modal so user can try manually
          document.getElementById('joinInput').value=finalTok.toUpperCase();
          document.getElementById('joinHint').textContent='Tap Connect to retry';
          openOv('joinOv');
          setStatus('READY');
        }
      }, 1200);
    }
  } else if(freq&&/^\d{4}$/.test(freq)){
    currentFreq=freq;
    document.getElementById('freqDisp').textContent=freq;
    await startPeer();
    setStatus('READY');updateUI();
  }

  // If launched as installed PWA (standalone/fullscreen), read URL from
  // window.location since navigator doesn't expose launch queue widely yet
  if(window.matchMedia('(display-mode: standalone)').matches || navigator.standalone){
    console.log('[WT] Running as installed PWA');
  }
});
</script>
</body>
</html>
